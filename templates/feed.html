<!-- new -->
<!DOCTYPE html>
<html>
<head>
    <title>Feed | DaBlog</title>
    <link rel="stylesheet" href="/static/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<div id="main-content">
    <div class="top-bar">
        <div class="brand">
            DaBlog.
        </div>
        
        <div class="user-box">
            <div class="user-name" onclick="openProfile('{{ session.username }}')">
                <span>@{{ current_username }}</span>
                {% if is_admin %}
                    <span class="admin-tag">Admin</span>
                {% endif %}
            </div>
            
            <div class="user-meta">
                üí¨ <span id="post-count">{{ post_count }}</span> posts
            </div>
            
            
            <a href="/logout" class="logout-btn">Logout</a>
        </div>
    </div>
    
    <form class="composer" onsubmit="createPost(event)">
        <div id="mute-overlay" class="mute-overlay hidden">
            You are muted
        </div>

        <!-- Top row -->
        <div class="composer-header">
            <div class="segmented-control" id="post-type">
                <button type="button" class="active" onclick="setPostType('text')">Text</button>
                <button type="button" onclick="setPostType('poll')">Poll</button>
            </div>
            
            <input type="hidden" id="post-type-input" value="text">
            
            
            <button class="post-btn" id="post-submit-btn">Post</button>
        </div>
        
        <!-- Text formatting -->
        <div class="format-bar">
            <button type="button" onclick="wrap('[b]', '[/b]')"><b>B</b></button>
            <button type="button" onclick="wrap('[i]', '[/i]')"><i>I</i></button>
            <button type="button" onclick="wrap('[u]', '[/u]')"><u>U</u></button>
            <button type="button" onclick="wrap('[s]', '[/s]')"><s>S</s></button>
            <span class="divider"></span>
            <button type="button" onclick="wrap('[size=medium]', '[/size]')">M</button>
            <button type="button" onclick="wrap('[size=large]', '[/size]')">L</button>
            <button type="button" onclick="removeFormatting()">‚úï</button>
        </div>
        
        <!-- Text -->
        <textarea id="post-content" placeholder="Say something..."></textarea>
        
        <!-- Poll -->
        <div id="poll-box" class="poll-box" style="display:none;">
            <input type="text" id="poll-question" placeholder="Poll question">
            
            <div id="poll-options">
                <input placeholder="Option 1">
                <input placeholder="Option 2">
            </div>
            
            <button type="button" class="add-option" onclick="addOption()">+ Add option</button>
        </div>
        
        
    </form>
    
    <hr>
    
    <div id="posts-container">
        {% for post in posts %}
        <div class="post {% if post.is_public == 0 %}private{% endif %}" id="post-{{ post.id }}">
            {% if not post.is_deleted_user %}
                <span class="username"
                      onclick="openProfile('{{ post.username }}')"><b>
                    @{{ post.username }}</b>
                </span>
            {% else %}
                <span class="username deleted-user"><b>
                    {{ post.username }}</b>
                </span>
            {% endif %}

            
            {% if post.is_admin %}<span class="admin-tag">Admin</span>{% endif %}
            
            {% if post.type == "poll" %}
                <div class="poll">
                    <h4 class="poll-question">{{ post.question }}</h4>
                    
                    {% set total = post.options | sum(attribute='votes') %}
                    
                    {% for opt in post.options %}
                        {% set percent = (opt.votes / total * 100) if total > 0 else 0 %}
                        
                        <div class="poll-option" data-option-id="{{ opt.id }}" onclick="vote({{ opt.id }})">
                            <div class="poll-bar {{ 'my-vote' if opt.voted_by_me else 'other-vote' }}"
                                 style="width: {{ percent }}%">
                            </div>
                            
                            <span class="poll-text" data-label="{{ opt.text }}">
                                {{ opt.text }} - {{ opt.votes }}
                            </span>
                            
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="post-content collapsed" id="post-content-{{ post.id }}">{{ post.content | safe }}</p>
                <button class="read-toggle" onclick="togglePost(this, {{ post.id }})">
                    Read more
                </button>

            {% endif %}
            
            
            <div class="post-footer">
                <div class="post-actions">
                    <a href="#"
                       class="action-btn like-btn {% if post.liked_by_me %}liked{% endif %}"
                       onclick="toggleLike(event, {{ post.id }})"
                       id="like-{{ post.id }}">
                       ‚ù§Ô∏è <span>{{ post.like_count }}</span>
                    </a>
                    
                    {% if post.user_id == current_user or is_admin %}
                        {% if post.type != "poll" %}
                            <a href="/edit/{{ post.id }}" class="action-btn edit-btn">
                                Edit
                            </a>
                        {% endif %}
                        
                        <a href="#"
                           class="action-btn delete-btn"
                           onclick="deletePost(event, {{ post.id }})">
                            Delete
                        </a>
                    {% endif %}
                </div>
                <span class="post-time">{{ post.time }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div id="profile-overlay" class="profile-overlay hidden">
    <div class="profile-card">
        <button class="close-btn" onclick="closeProfile()">‚úï</button>

        <div class="profile-header">
            <h2 id="profile-username"></h2>
            <div class="profile-meta">
                <span>ID: <span id="profile-id"></span></span>
                <span>Posts: <span id="profile-count"></span></span>
            </div>
        </div>

        <div id="profile-actions"></div>

        <div id="profile-posts"></div>
    </div>
</div>

<div id="admin-overlay" class="profile-overlay hidden">
  <div class="profile-card">
    <button class="close-btn" onclick="closeAdmin()">‚úï</button>
    <h2>Admin Panel</h2>

    <details open>
      <summary>Users</summary>
      <div id="admin-users"></div>
    </details>

    <details>
      <summary>Private Posts</summary>
      <div id="admin-private"></div>
    </details>

    <details>
      <summary>Add a Banned Word</summary>
      <input id="curse-input" placeholder="new curse word" class="modal-input" style="margin-bottom:10px;">
      <button onclick="addCurse()">Add</button>
    </details>
  </div>
</div>

<!-- ===== CUSTOM MODALS & TOASTS ===== -->
<div id="custom-modal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-title" id="modal-title"></div>
        <div class="modal-body" id="modal-body"></div>
        <div id="modal-input-container" style="display:none;">
            <input type="text" id="modal-input" class="modal-input" autocomplete="off">
        </div>
        <div class="modal-actions">
            <button id="modal-cancel" class="btn-ghost">Cancel</button>
            <button id="modal-confirm" class="btn-primary">OK</button>
        </div>
    </div>
</div>

<div id="toast-container"></div>

<div id="search-overlay" class="profile-overlay hidden">
    <div class="profile-card">
        <button class="close-btn" onclick="closeSearch()">‚úï</button>
        <h2>Search People</h2>
        <div class="search-box">
            <input type="text" id="user-search-input" placeholder="Type a username..." 
                   oninput="performFuzzySearch(this.value)" class="modal-input">
        </div>
        <div id="fuzzy-results" style="margin-top: 20px;">
            </div>
    </div>
</div>

<div class="dm-sidebar" id="dm-sidebar">
    <div id="dm-list"></div> 

    <div class="sidebar-footer">
        <a href="/chat" class="dm-item">
            <div class="dm-icon">üí¨</div>
            <span class="dm-name">Chats</span>
        </a>
        <button class="dm-item search-trigger" onclick="searchPeople()">
            <div class="dm-icon">üîç</div>
            <span class="dm-name">Search people</span>
        </button>        
    </div>
</div>

<div class="mobile-footer">
    <a href="/feed">üè†</a>
    <a href="#" onclick="searchPeople()">üîç</a>
    <a href="/chat">üí¨</a>
</div>

</body>
</html>

<script src="/static/core.js"></script>
<script>
/* ===== EXISTING LOGIC UPDATED ===== */

// Only check the user's status once
fetch("/api/user/{{ session.username }}")
.then(r=>r.json())
.then(d=>{
    if (d.user.is_muted) {
        document.querySelector(".composer").classList.add("muted");
        document.getElementById("mute-overlay").classList.remove("hidden");
    }
});

let pollConfirmed = false;

document.querySelectorAll("textarea").forEach(textarea => {
    textarea.addEventListener("input", () => {
        textarea.style.height = "auto";
        textarea.style.height = textarea.scrollHeight + "px";
    });
});

function togglePost(btn, postId) {
    const content = document.getElementById("post-content-" + postId);
    content.classList.toggle("collapsed");
    btn.textContent = content.classList.contains("collapsed")
        ? "Read more"
        : "Read less";
}

document.querySelectorAll(".post-content").forEach(post => {
    if (post.scrollHeight <= post.clientHeight) {
        post.nextElementSibling.style.display = "none";
    }
});

function toggleLike(e, postId) {
    e.preventDefault();

    fetch(`/like/${postId}`, {
        method: "POST"
    })
    .then(res => res.json())
    .then(data => {
        const btn = document.getElementById(`like-${postId}`);
        const countSpan = btn.querySelector("span");

        countSpan.textContent = data.like_count;

        btn.classList.toggle("liked", data.action === "liked");
    });
}

// UPDATED: Now uses Custom Confirm and Toast
async function deletePost(e, postId) {
    e.preventDefault();

    const confirmed = await customConfirm("Are you sure you want to delete this post?", "Delete Post", true);
    if (!confirmed) return;

    fetch(`/delete/${postId}`, {
        method: "POST"
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById(`post-${postId}`).remove();
        
        if (data.post_count !== undefined) {
            document.getElementById("post-count").textContent = data.post_count;
        }
        showToast("Post deleted successfully", "success");
    });
}

// UPDATED: Uses Custom Alert
async function createPost(e) {
    e.preventDefault();

    const type = document.getElementById("post-type-input").value;
    const btn = document.getElementById("post-submit-btn");

    // üõë First click for polls = confirmation only
    if (type === "poll" && !pollConfirmed) {
        await customAlert("‚ö†Ô∏è Polls cannot be edited after posting.\nDouble-check your question and options before continuing.");

        pollConfirmed = true;
        btn.textContent = "Confirm Post";
        return;
    }

    // ‚úÖ real submit starts here
    const formData = new FormData();
    formData.append("type", type);

    if (type === "poll") {
        formData.append(
            "question",
            document.getElementById("poll-question").value
        );

        document.querySelectorAll("#poll-options input").forEach(i => {
            if (i.value.trim()) {
                formData.append("options[]", i.value);
            }
        });
    } else {
        formData.append(
            "content",
            document.getElementById("post-content").value
        );
    }

    fetch("/post", {
        method: "POST",
        body: formData
    })
    .then(async res => {
        if (res.status === 403) {
            document.querySelector(".composer").classList.add("muted");
            document.getElementById("mute-overlay").classList.remove("hidden");
            throw new Error("Muted");
        }
        return res.json();
    })
    .then(data => {
        document.getElementById("post-count").textContent = data.post_count;
        location.reload();
    })
    .catch(()=>{});
}

function wrap(start, end) {
    const ta = document.getElementById("post-content");
    const s = ta.selectionStart;
    const e = ta.selectionEnd;

    ta.value =
        ta.value.substring(0, s) +
        start +
        ta.value.substring(s, e) +
        end +
        ta.value.substring(e);

    ta.focus();
    ta.selectionStart = s + start.length;
    ta.selectionEnd = e + start.length;
}

function togglePoll() {
    const isPoll = document.getElementById("post-type-input").value === "poll";

    document.getElementById("poll-box").style.display = isPoll ? "block" : "none";
    document.querySelector(".format-bar").style.display = isPoll ? "none" : "flex";
    document.getElementById("post-content").style.display = isPoll ? "none" : "block";
}

// UPDATED: Uses Custom Alert
async function addOption() {
    const box = document.getElementById("poll-options");
    if (box.children.length >= 5) {
        await customAlert("Max 5 options");
        return;
    }
    const input = document.createElement("input");
    input.placeholder = `Option ${box.children.length + 1}`;
    box.appendChild(input);
}

// UPDATED: Uses Custom Alert
function vote(optionId) {
    fetch(`/vote/${optionId}`, { method: "POST" })
        .then(res => res.json())
        .then(async data => {
            if (data.error) {
                await customAlert(data.error);
                return;
            }

            const total = data.options.reduce((s, o) => s + o.votes, 0);

            data.options.forEach(opt => {
                const row = document.querySelector(
                    `.poll-option[data-option-id="${opt.id}"]`
                );

                const bar = row.querySelector(".poll-bar");
                const text = row.querySelector(".poll-text");

                const percent = total ? (opt.votes / total) * 100 : 0;

                bar.style.width = percent + "%";
                bar.classList.toggle("my-vote", opt.voted_by_me);
                bar.classList.toggle("other-vote", !opt.voted_by_me);

                const label = text.dataset.label;
                text.textContent = `${label} - ${opt.votes}`;
            });
        });
}

function setPostType(type) {
    document.getElementById("post-type-input").value = type;

    document.querySelectorAll("#post-type button").forEach(b =>
        b.classList.toggle("active", b.textContent.toLowerCase() === type)
    );

    // reset poll confirmation state
    pollConfirmed = false;

    const btn = document.getElementById("post-submit-btn");
    btn.textContent = type === "poll" ? "Confirm" : "Post";

    togglePoll();
}

function closeProfile() {
    document.body.classList.remove("blurred");
    document.getElementById("profile-overlay").classList.add("hidden");
}

// UPDATED: Uses Custom Prompts and Toasts
async function changeUsername() {
    const newUsername = await customPrompt("Change Username", "Enter new username");
    
    if (newUsername === null) return; // Cancelled
    
    if (!newUsername || newUsername.trim().length < 3) {
        await customAlert("Username must be at least 3 characters.");
        return;
    }

    const password = await customPrompt("Confirm Password", "Enter current password", "password");
    if (!password) return;

    fetch("/account/username", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            username: newUsername.trim(),
            password: password
        })
    })
    .then(res => res.json())
    .then(async data => {
        if (data.error) {
            showToast(data.error, "error");
            return;
        }
        showToast("Username updated! Reloading...", "success");
        setTimeout(() => location.reload(), 1000);
    });
}

// UPDATED: Uses Custom Prompts and Toasts
async function changePassword() {
    const oldPass = await customPrompt("Change Password", "Enter current password", "password");
    if (!oldPass) return;

    const newPass = await customPrompt("Change Password", "Enter new password", "password");
    if (newPass === null) return;
    
    if (!newPass || newPass.length < 6) {
        await customAlert("Password must be at least 6 characters.");
        return;
    }

    fetch("/account/password", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            old_password: oldPass,
            new_password: newPass
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            showToast(data.error, "error");
            return;
        }

        showToast("Password updated!", "success");
    });
}

// UPDATED: Uses Custom Confirm
async function deleteAccount() {
    const confirmed = await customConfirm("This will permanently delete your account.", "Delete Account", true);
    if (!confirmed) return;

    fetch("/account/delete", { method: "POST" })
        .then(() => location.reload());
}

function highlightPost(postId) {
    closeProfile();
    const post = document.getElementById(`post-${postId}`);
    if (!post) return;

    post.scrollIntoView({ behavior: "smooth", block: "center" });
    post.classList.add("highlight");

    setTimeout(() => post.classList.remove("highlight"), 1500);
}

function openAdmin() {
    fetch("/admin/panel")
    .then(r => r.json())
    .then(d => {
        const box = document.getElementById("admin-users");
        box.innerHTML = d.users.map(u => `
            <div>
              <span onclick="openProfile('${u.username}')">@${u.username}</span>
              <button onclick="toggleMute(${u.id})">
                ${u.is_muted ? "Unmute" : "Mute"}
              </button>
            </div>
        `).join("");

        const priv = document.getElementById("admin-private");
        priv.innerHTML = d.private_posts.length
            ? d.private_posts.map(renderReadonlyPost).join("")
            : "<p class='muted'>No private posts</p>";

        document.body.classList.add("blurred");
        document.getElementById("admin-overlay").classList.remove("hidden");
    })
    .catch(async err => {
        console.error("Admin panel failed:", err);
        await customAlert("Admin panel failed to load");
    });
}

function closeAdmin() {
    document.body.classList.remove("blurred");
    document.getElementById("admin-overlay").classList.add("hidden");
}

function toggleMute(id) {
    fetch(`/admin/mute/${id}`, { method:"POST" })
        .then(()=>openAdmin());
}

async function addCurse() {
    const w = document.getElementById("curse-input").value;
    fetch("/admin/curse", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ word:w })
    }).then(()=> showToast("Word banned", "success"));
}

// Sidebar DM List should just be links
async function loadDMs() {
    const res = await fetch('/api/dm_list');
    const data = await res.json();
    const container = document.getElementById('dm-list');
    if (!container) return;
    
    container.innerHTML = data.users.map(u => `
        <a href="/chat/${u.username}" class="dm-item">
            <div class="dm-icon">${u.username[0].toUpperCase()}</div>
            <div class="dm-name">
                <b>@${u.username}</b>
            </div>
        </a>
    `).join('');
}

// Make sure to call it when the page loads!
document.addEventListener("DOMContentLoaded", loadDMs);

function openProfile(username) {
    if (!username) {
        console.error("Username missing");
        return;
    }

    fetch(`/api/user/${encodeURIComponent(username)}`)
        .then(res => {
            if (!res.ok) throw new Error("User not found");
            return res.json();
        })
        .then(data => {
            document.getElementById("profile-username").textContent = data.user.username;
            document.getElementById("profile-id").textContent = data.user.id;
            document.getElementById("profile-count").textContent = data.user.post_count;
            
            const actions = document.getElementById("profile-actions");
            actions.innerHTML = "";
            
            actions.innerHTML = `
                <button class="message-btn" onclick="location.href='/chat/${data.user.username}'">
                    üí¨ Message
                </button>
            `;
            
            if (data.user.is_me) {
                // ADDED: The wrapper class for the select
                actions.innerHTML = `
                    <button onclick="changeUsername()">Change Username</button>
                    <button onclick="changePassword()">Change Password</button>
                    <button class="danger readonly" onclick="deleteAccount()">Delete Account</button>
                    <select onchange="setTheme(this.value)">
                        <option value="">Midnight Pulse</option>
                        <option value="polar">Polar Breeze</option>
                        <option value="pumpkin">Pumpkin Spice</option>
                        <option value="spring">Spring Bloom</option>
                    </select>
                `;
            }
            if (data.user.is_me && {{ 'true' if is_admin else 'false' }}) {
                actions.innerHTML += `
                    <button onclick="openAdmin()">Admin Panel</button>
                `;
            }


            
            const postsBox = document.getElementById("profile-posts");
            postsBox.innerHTML = "";

            data.posts.forEach(p => {
                if (p.type === "poll") {
                    postsBox.innerHTML += `
                        <div class="post readonly" onclick="highlightPost(${p.id})">
                            <h4 class="poll-question">${p.question}</h4>
                            ${p.options.map(o => `
                                <div class="poll-option disabled">
                                    <div class="poll-bar" style="width:0"></div>
                                    <span>${o.text} ‚Äì ${o.votes}</span>
                                </div>
                            `).join("")}
                            <div class="post-footer">
                                ‚ù§Ô∏è ${p.like_count} ¬∑ ${p.time}
                            </div>
                        </div>
                    `;
                } else {
                    postsBox.innerHTML += `
                        <div class="post readonly" onclick="highlightPost(${p.id})">
                            <div class="post-content">${p.content}</div>
                            <div class="post-footer">
                                ‚ù§Ô∏è ${p.like_count} ¬∑ ${p.time}
                            </div>
                        </div>
                    `;
                }
            });
            document.body.classList.add("blurred");
            document.getElementById("profile-overlay").classList.remove("hidden");
        })
        .catch(async err => {
            console.error(err);
            await customAlert("Failed to load profile");
        });
}
function renderReadonlyPost(p) {
    if (p.type === "poll") {
        return `
        <div class="post readonly">
            <div class="post-header">
                <b>@${p.username}</b>
                <span>${p.time}</span>
            </div>
            <p class="poll-question">${p.question}</p>
            ${p.options.map(o => `
                <div class="poll-option disabled">
                    ${o.text}
                    <span>${o.votes} votes</span>
                </div>
            `).join("")}
        </div>`;
    }

    return `
    <div class="post readonly">
        <div class="post-header">
            <b>@${p.username}</b>
            <span>${p.time}</span>
        </div>
        <div class="post-content">${p.content}</div>
    </div>`;
}
</script>